autoload -U zmv
autoload -U +X compinit && compinit -d $HOME/.cache/zsh/zcompdump-$ZSH_VERSION
autoload -U +X bashcompinit && bashcompinit

BASE16_SHELL=$HOME/.config/base16-shell/
[ -n "$PS1" ] && [ -s $BASE16_SHELL/profile_helper.sh ] && eval "$($BASE16_SHELL/profile_helper.sh)"

# VARS {{{

# Path to your oh-my-zsh installation.
export ZSH=$HOME/.oh-my-zsh

# If TERM is set to xterm-256color mutt has problems redrawing
# after viewing attachments.
# See: https://superuser.com/questions/844058/tmux-mutt-not-redrawing
export TERM="screen-256color"

export PATH=$HOME/.dotfiles/bin/:$HOME/.tmuxifier/bin/:$HOME/bin:/usr/local/bin:$HOME/.gem/ruby/2.4.0/bin:/bin:/usr/local/bin:/usr/bin:/usr/bin/vendor_perl:/usr/bin/core_perl
export EDITOR="nvim"
export BROWSER="/usr/bin/firefox"
export MANPATH="/usr/local/man:$MANPATH"

# }}}

# POWERLINE {{{

if hash powerline-daemon 2>/dev/null; then
  powerline-daemon -q
  . /usr/lib/python3.6/site-packages/powerline/bindings/zsh/powerline.zsh
fi

# }}}

# VIM KEYBINDING {{{
bindkey -v

# http://zsh.sourceforge.net/Doc/Release/Zsh-Line-Editor.html
bindkey -M vicmd '^' vi-beginning-of-line
bindkey -M vicmd '0' vi-beginning-of-line

bindkey -M vicmd 'c' vi-backward-char
bindkey -M vicmd 'r' vi-forward-char
bindkey -M vicmd 't' history-search-backward
bindkey -M vicmd 's' history-search-forward

# Vi mode breaks up and down arrow keys with history search.
# This is the fix:
# https://github.com/robbyrussell/oh-my-zsh/issues/1720#issuecomment-286366959

if [[ "${terminfo[kcuu1]}" != "" ]]; then
  autoload -U up-line-or-beginning-search
  zle -N up-line-or-beginning-search
  bindkey "${terminfo[kcuu1]}" up-line-or-beginning-search
fi
# start typing + [Down-Arrow] - fuzzy find history backward
if [[ "${terminfo[kcud1]}" != "" ]]; then
  autoload -U down-line-or-beginning-search
  zle -N down-line-or-beginning-search
  bindkey "${terminfo[kcud1]}" down-line-or-beginning-search
fi

bindkey -M vicmd 'b' backward-word
bindkey -M vicmd 'Ã©' forward-word

bindkey -M vicmd 'yy' vi-yank-whole-line
bindkey -M vicmd 'Y' vi-yank-eol

bindkey -M vicmd 'l' vi-change-eol
bindkey -M vicmd 'L' vi-change-eol
bindkey -M vicmd 'll' vi-change-whole-line

# }}}

# Functions {{{

# }}}

if hash tmuxifier 2>/dev/null;
then
  eval "$(tmuxifier init -)"
fi

# Oh My Zsh {{{

ZSH_THEME="powerlevel9k/powerlevel9k"

precmd() {
  if hash task 2>/dev/null; then
    task="task rc.verbose:nothing"
    overdue_count=$($(echo $task) +READY +OVERDUE count)
    today_count=$($(echo $task) +READY +DUETODAY count)
    tomorrow_count=$($(echo $task) +READY +TOMORROW count)
    urgent_count=$($(echo $task) +READY urgency.above:10 count)

    task_indicator(){
      local output=""
      if [[ "$overdue_count" -gt "0" ]]; then
        output="ðŸ’€ $overdue_count"
      elif [[ "$today_count" -gt "0" ]]; then
        output="ðŸ˜± $today_count"
      elif [[ "$tomorrow_count" -gt "0" ]]; then
        output="ðŸ“… $tomorrow_count"
      elif [[ "$urgent_count" -gt "0" ]]; then
        output="â—$urgent_count"
      else
      fi

      echo -n "$output"
    }

    task_color(){
      local color=""
      if [[ "$overdue_count" -gt "0" ]]; then
        color="red"
      elif [[ "$today_count" -gt "0" ]]; then
        color="016"
      elif [[ "$tomorrow_count" -gt "0" ]]; then
        color="yellow"
      else
      fi

      echo -n "$color"
    }

    POWERLEVEL9K_CUSTOM_TASKWARRIOR="task_indicator"
    POWERLEVEL9K_CUSTOM_TASKWARRIOR_BACKGROUND="$(task_color)"
  fi
}

POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(context custom_taskwarrior dir dir_writable vcs)
POWERLEVEL9K_RIGHT_PROMPT_ELEMENTS=(status vi_mode)


# Fish shell shortening strategy for directories
POWERLEVEL9K_SHORTEN_DIR_LENGTH=1
POWERLEVEL9K_SHORTEN_DELIMITER=""
POWERLEVEL9K_SHORTEN_STRATEGY="truncate_from_right"

if [ "$BASE16_THEME" = "base16_solarized-light" ]
then
  POWERLEVEL9K_COLOR_SCHEME='light'
fi

# Hide context module when user is gabo
DEFAULT_USER="gaalcaras"

# Uncomment the following line to enable command auto-correction.
ENABLE_CORRECTION="true"

# Which plugins would you like to load? (plugins can be found in ~/.oh-my-zsh/plugins/*)
# Custom plugins may be added to ~/.oh-my-zsh/custom/plugins/
# Example format: plugins=(rails git textmate ruby lighthouse)
# Add wisely, as too many plugins slow down shell startup.
plugins=(git cp pass taskwarrior vi-mode zsh-dircolors-solarized emoji)

source $ZSH/oh-my-zsh.sh
# }}}

# ALIAS {{{
alias reload='source ~/.zshrc'

alias dark='base16_solarized-dark && reload'
alias light='base16_solarized-light && reload'

alias stats="fc -l 1 | awk '{CMD[\$2]++;count++;}END { for (a in CMD)print CMD[a] \" \" CMD[a]/count*100 \"% \" a;}' | grep -v \"./\" | column -c3 -s \" \" -t | sort -nr | nl | head -n20"

# ls aliases
alias ls="ls -F --color=auto --block-size=M"
alias la="ls -a"
alias ll="ls -l"
alias lla="ll -a"
alias ldot="ll -d .*"

alias mmv='noglob zmv -W'

# git aliases
alias glog="git log --graph --pretty=format:'%Cred%h%Creset %an: %s - %Creset %C(yellow)%d%Creset %Cgreen(%cr)%Creset' --abbrev-commit --date=relative"
alias gs='git status -sb'
alias gst='git status -sb'
alias gc='git commit'
alias ga='git add -p'

# Locale stuff
alias git='LC_ALL=C git'
alias khal='LC_TIME=C khal'
alias ikhal='LC_TIME=C ikhal'

# Tools
alias nv="nvim"
alias mutt="neomutt -n"
alias mr='mr -mj 5' # Multi-repos with minimal output and 5 parallel jobs

# Development
alias nvtest='nvim +UpdateRemotePlugins +qall && nvim "+TranscribeAudio ~/Videos/googlepixel.webm"'

# Dotfiles
function vimrc() {
  tmpdir=$(pwd)
  cd "$HOME/.dotfiles/vim"
  $EDITOR $HOME/.dotfiles/vim/vimrc.symlink
  cd "$tmpdir"
}

function zshrc() {
  tmpdir=$(pwd)
  cd "$HOME/.dotfiles/zsh"
  $EDITOR $HOME/.dotfiles/zsh/zshrc.symlink
  cd "$tmpdir"
}

function muttrc() {
  tmpdir=$(pwd)
  cd "$HOME/.dotfiles/mutt"
  $EDITOR $HOME/.dotfiles/mutt/muttrc
  cd "$tmpdir"
}

# Directories
alias dotfiles="cd ~/.dotfiles"
alias pdw="cd ~/Documents/phd-writing"

# Note taking
zettel() {
  local cmd="Note $@"
  nvim -c "$cmd"
}

compdef '_path_files -W $HOME/Zettelkasten/zettel' zettel
compdef '_path_files -W $HOME/Nextcloud/Notes -g "*.md"' note

# }}}

if hash register-python-argcomplete 2>/dev/null; then
  eval "$(register-python-argcomplete pubs)"
fi

# vim: fdm=marker fmr={{{,}}} fdl=0 fen
